{% extends "base.html" %}
{% block title %}主任工作台 (V2.0){% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-user-shield me-2"></i>主任工作台</h2>
        <div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTaskModal"><i class="fas fa-plus me-1"></i> 分配新任务</button>
            <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#manageEmployeesModal" onclick="loadEmployees()"><i class="fas fa-users me-1"></i> 管理员工</button>
        </div>
    </div>
    <div id="taskListContainer"></div>
</div>

<!-- Create Task Modal -->
<div class="modal fade" id="createTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">分配新任务</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form id="createTaskForm">
                <div class="mb-3"><label class="form-label">任务标题 *</label><input type="text" class="form-control" name="title" required></div>
                <div class="mb-3"><label class="form-label">具体任务描述 *</label><textarea class="form-control" name="description" rows="3" required></textarea></div>
                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label">任务类别</label><input type="text" class="form-control" name="category"></div>
                    <div class="col-md-6 mb-3"><label class="form-label">负责人 *</label><select class="form-select" name="assignee_id" required>{% for e in employees %}<option value="{{ e.id }}">{{ e.name }}</option>{% endfor %}</select></div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label">完成时限 *</label><input type="date" class="form-control" name="due_date" required></div>
                    <div class="col-md-6 mb-3"><label class="form-label">任务级别 *</label><select class="form-select" name="priority" required><option>平</option><option>缓</option><option>急</option><option>紧急</option></select></div>
                </div>
                <div class="mb-3"><label class="form-label">备注</label><textarea class="form-control" name="remarks" rows="2"></textarea></div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" onclick="createTask()">确认分配</button>
        </div>
    </div></div>
</div>
{% endblock %}
{% block scripts %}
<script>
    const priorityMap = { '紧急': 'danger', '急': 'warning', '平': 'primary', '缓': 'secondary' };
    
    function renderTasks(tasks) {
        const container = document.getElementById('taskListContainer');
        container.innerHTML = `
            <table class="table table-hover align-middle bg-white">
                <thead><tr><th>任务标题</th><th>负责人</th><th>截止日期</th><th>进度</th><th>状态</th></tr></thead>
                <tbody>${tasks.map(task => `
                    <tr>
                        <td>
                            <strong>${task.title}</strong>
                            <span class="badge bg-${priorityMap[task.priority]} ms-2">${task.priority}</span>
                            <br><small class="text-muted">${task.category || ''}</small>
                        </td>
                        <td>${task.assignee}</td>
                        <td>${task.due_date}</td>
                        <td>
                            <div class="progress"><div class="progress-bar" style="width: ${task.progress}%">${task.progress}%</div></div>
                        </td>
                        <td>
                            <select class="form-select form-select-sm" onchange="updateTaskStatus(${task.id}, this.value)">
                                <option value="pending" ${task.status === 'pending' ? 'selected' : ''}>待处理</option>
                                <option value="in_progress" ${task.status === 'in_progress' ? 'selected' : ''}>进行中</option>
                                <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>已完成</option>
                            </select>
                        </td>
                    </tr>
                `).join('')}</tbody>
            </table>
        `;
    }

    async function loadTasks() {
        const tasks = await apiRequest('/api/tasks');
        renderTasks(tasks);
    }

    async function createTask() {
        const form = document.getElementById('createTaskForm');
        const data = Object.fromEntries(new FormData(form));
        const result = await apiRequest('/api/tasks', 'POST', data);
        showToast(result.message, result.success ? 'success' : 'danger');
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('createTaskModal')).hide();
            loadTasks();
        }
    }

    async function updateTaskStatus(taskId, status) {
        await apiRequest(`/api/tasks/${taskId}/status`, 'POST', {status});
        loadTasks(); // Refresh to show correct progress/status link
    }
    
    async function loadEmployees() {
        const employees = await apiRequest('/api/director/employees');
        const body = document.getElementById('employeeListBody');
        body.innerHTML = employees.map(e => `
            <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                <span>${e.name} (${e.username})</span>
                <button class="btn btn-sm btn-outline-warning" onclick="resetPassword(${e.id}, '${e.name}')">重置密码</button>
            </div>
        `).join('');
    }

    async function resetPassword(userId, userName) {
        const newPassword = prompt(`请输入为 "${userName}" 设置的新密码:`);
        if (newPassword) {
            const result = await apiRequest('/api/director/reset_password', 'POST', {user_id: userId, new_password: newPassword});
            showToast(result.message, result.success ? 'success' : 'danger');
        }
    }

    document.addEventListener('DOMContentLoaded', loadTasks);
</script>
{% endblock %}